// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  PENDING
  DELETED
}

model User {
  id        String      @id @db.Uuid @default(uuid())
  username  String      @unique @db.VarChar(255)
  email     String      @unique @db.VarChar(255)
  password  String      @db.VarChar(255)
  salt      String      @db.VarChar(255)
  status    UserStatus  @default(ACTIVE)
  roleId    String      @db.Uuid

  role      Role        @relation(fields: [roleId], references: [id])
  keyToken              KeyToken[]
  
  @@index([username], name: "idx_user_username")
  @@index([email], name: "idx_user_email")
}

model Resource {
  id          String      @id @db.Uuid @default(uuid())
  name        String     @unique @db.VarChar(255)
  slug        String     @unique @db.VarChar(255)
  description String?     @db.Text
  roles       Grant[]
}

enum RoleStatus {
  ACTIVE
  INACTIVE
}

model Role {
  id          String      @id @db.Uuid @default(uuid())
  name        String      @unique @db.VarChar(255)
  slug        String      @unique @db.VarChar(255)
  status      RoleStatus  @default(ACTIVE)
  description String?     @db.Text
  grants      Grant[]     @relation("RoleGrants")
  users       User[]

  @@index([status], name: "idx_role_status")
  @@index([slug], name: "idx_role_slug")
}

model Grant {
  id          String      @id @db.Uuid @default(uuid())
  roleId    String      @db.Uuid
  resourceId String     @db.Uuid
  role      Role        @relation("RoleGrants", fields: [roleId], references: [id])
  resource  Resource    @relation(fields: [resourceId], references: [id])
  action    String      @db.VarChar(20) // create:any | create:own | ...
  attribute String      @db.VarChar(20) // * | '*, !password | ...

  @@unique([roleId, resourceId, action ], name: "unique_role_resource_action")
  @@index([roleId], name: "idx_grant_role")
}

enum OTPStatus {
  ACTIVE
  PENDING
  BLOCKED
}

model OTP {
  id        String      @id @db.Uuid @default(uuid())
  token     String      @unique @db.VarChar(255)
  email     String      @db.VarChar(255)
  status    OTPStatus   @default(ACTIVE)
  expiresAt DateTime    @default(dbgenerated("NOW() + INTERVAL '60 seconds'"))
  createdAt DateTime    @default(now()) @db.Timestamp(6)
  updatedAt DateTime    @updatedAt @db.Timestamp(6)

  @@index([email], name: "idx_otp_email")
  @@index([status], name: "idx_otp_status")
  @@index([expiresAt], name: "idx_otp_expires_at")
}

enum ApiKeyPermission {
  READ
  WRITE
  DELETE
  ALL
}

model ApiKey {
  id        String @id @db.Uuid @default(uuid())
  key       String @unique @db.VarChar(255)
  status    Boolean @default(true)
  permissions ApiKeyPermission[] @default([])  
  createdAt DateTime    @default(now()) @db.Timestamp(6)
  updatedAt DateTime    @updatedAt @db.Timestamp(6)
}

model KeyToken {
  id                String @id @db.Uuid @default(uuid())
  browserId         String @db.VarChar(255)
  refreshTokensUsed String[] @default([]) @db.Text
  refreshToken      String @db.Text
  userId            String @db.Uuid
  user              User @relation(fields: [userId], references: [id])
  createdAt         DateTime    @default(now()) @db.Timestamp(6)
  updatedAt         DateTime    @updatedAt @db.Timestamp(6)

  @@unique([userId, browserId], name: "unique_user_browser")
}
